# Security Implementation

## Overview

The MCP Server implements comprehensive security measures to protect file system access while enabling LLMs to browse and read files safely. The security architecture is based on multiple layers of protection including authentication, authorization, audit logging, and input validation.

## Authentication

### OAuth2 Bearer Tokens

The API uses OAuth2 Bearer tokens for authentication. All requests must include a valid token in the `Authorization` header:

```
Authorization: Bearer <token>
```

Tokens are generated by the AuthService and have a configurable expiration time (default: 24 hours).

### Token Management

- Tokens are cryptographically secure random strings
- Tokens are stored securely and validated on each request
- Expired tokens are automatically cleaned up
- Tokens can be revoked manually if needed

## Authorization

### Attribute-Based Access Control (ABAC)

The server implements Attribute-Based Access Control (ABAC) for fine-grained permissions. Access policies define:

- **Resources**: Which files or directories can be accessed
- **Principals**: Which users or groups can access the resources
- **Actions**: What operations are allowed (read, list, search)
- **Conditions**: Additional conditions that must be met

### Policy Examples

```json
{
  "name": "llm-read-policy",
  "description": "Allow LLMs to read files in allowed directories",
  "resources": ["/path/to/allowed/*"],
  "principals": ["llm-*"],
  "actions": ["read", "list"],
  "conditions": {}
}
```

### Path Validation

All file and directory paths are validated to prevent:

- Directory traversal attacks (e.g., `../../../etc/passwd`)
- Access to system or sensitive directories
- Invalid or malformed paths
- Absolute path access (paths must be relative to allowed directories)

## Audit Logging

### Comprehensive Logging

All access attempts are logged with:

- Timestamp
- User/principal identifier
- Resource accessed
- Action performed
- Outcome (success, denied, error)
- Client IP address
- Additional details

### Log Format

Audit logs are stored in JSON format for easy parsing and analysis:

```json
{
  "id": "unique-log-id",
  "timestamp": "2025-01-01T00:00:00Z",
  "principal": "llm-123",
  "resource": "directory:/home/user/documents",
  "action": "list",
  "outcome": "success",
  "details": "Listed directory with 5 items",
  "ip_address": "192.168.1.100"
}
```

### Log Storage

Audit logs are stored in a dedicated log file (`audit.log`) and can be configured to send logs to external systems for centralized monitoring.

## Data Protection

### File Content Protection

- File contents are never stored in memory longer than necessary
- Large files are streamed to prevent memory exhaustion
- File contents are not cached or stored in temporary files
- Encryption in transit is enforced with HTTPS

### Metadata Protection

- File and directory metadata is only accessible to authorized users
- Sensitive metadata is filtered from responses
- Permissions are checked for each access attempt

## Input Validation

### Path Sanitization

- Null bytes are removed from paths
- Control characters are filtered out
- Paths are resolved to prevent directory traversal
- Paths are validated against allowed directories

### Parameter Validation

- All API parameters are validated and sanitized
- Size limits are enforced for file reads
- Encoding parameters are validated
- Pagination parameters are checked for valid ranges

## Performance and Security Balance

### Caching

- Directory listings are cached to improve performance
- Cache entries have a time-to-live (TTL) to ensure freshness
- Cache size is limited to prevent memory exhaustion
- Cache is invalidated when directories change

### Rate Limiting

- API requests are rate-limited to prevent abuse
- Limits are configurable per user or group
- Excessive requests are logged and may trigger alerts
- Rate limiting is implemented at the middleware level

## Security Best Practices

### Deployment

- Always use HTTPS in production
- Restrict allowed directories to only what is necessary
- Regularly rotate secret keys
- Monitor audit logs for suspicious activity
- Keep dependencies up to date

### Configuration

- Set appropriate file size limits
- Configure cache sizes and TTL values
- Define access policies carefully
- Set up proper logging and monitoring

### Monitoring

- Regularly review audit logs
- Set up alerts for suspicious activity
- Monitor performance metrics
- Track error rates and investigate anomalies